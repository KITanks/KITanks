<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
      html, body {
        width: 100%;
        height: 100%;
        margin: 0px;
        border: 0;
      }

      #canvas {
        border:1px solid #d3d3d3;
      }

      #info {
        position: absolute;
        left: 0;
        bottom: 0;
        background: gray;
      }
    </style>
  </head>
    <body>
      <canvas id="canvas"></canvas>
      <div id="info"></div>

      <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function() {
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");

        var socket = new WebSocket("ws://192.168.178.30:3000");
        var uuid = -1;
        var tank = null;

        var tankList = [];
        var bulletList = [];

        var MAP_WIDTH = 2000;
        var MAP_HEIGHT = 1000;

        resize();

        socket.onopen = function() {
          Game.start();
        }

        socket.onerror = function() {
          setText("Connection error");
        }

        socket.onclose = function() {
          setText("Connection closed");
        }

        var Game = {
          start: function() {
            setInterval(function() {
              socket.send(JSON.stringify({
                pckid: 10,
                id: uuid,
                x: tank.x,
                y: tank.y,
                ang: tank.angle / Math.PI * 180
              }))
            }, 16);

            window.requestAnimationFrame(gameLoop);

            window.addEventListener('keydown', function (e) {
             e.preventDefault();
             Game.keys = (Game.keys || []);
             Game.keys[e.keyCode] = (e.type == "keydown");
            });

            window.addEventListener('keyup', function (e) {
              Game.keys[e.keyCode] = (e.type == "keydown");
            });
          },

          stop: function() {
            window.cancelAnimationFrame(gameLoop);
          }
        }

        function clear() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        socket.onmessage = function(message) {
          var data = JSON.parse(message.data);

          //console.log("> " + message.data);

          switch (data.pckid) {
            case 1:
              uuid = data.id;
              tank = new Tank(data.x, data.y, 1, 2);
              Game.start();
              break;
            case 2:
              tankList = data.tanks;
              break;
            case 3:
              Game.stop();
              break;
            case 4:
              bulletList = data.bullets;
              break;
            default:
          }
        }

        function sendData() {
          return JSON.stringify({
            pckid: 10,
            id: uuid,
            x: tank.x,
            y: tank.y,
            ang: tank.angle
          });
        }

        function gameLoop() {
          clear();

          tank.moveAngle = 0;
          tank.speed = 0;

          if (Game.keys && (Game.keys[37] || Game.keys[65])) {tank.rotateRight();}
          if (Game.keys && (Game.keys[39] || Game.keys[68])) {tank.rotateLeft();}
          if (Game.keys && (Game.keys[38] || Game.keys[87])) {tank.moveForward();}
          if (Game.keys && (Game.keys[40] || Game.keys[83])) {tank.moveBackward();}
          if (Game.keys && (Game.keys[86] || Game.keys[32])) {shot();}

          for(var i = 0; i < bulletList.length; i++) {
            drawBullet(bulletList[i].x, bulletList[i].y, bulletList[i].ang);
          }

          tank.update();

          for(var i = 0;i < tankList.length; i++) {
            drawTank(tankList[i].id, tankList[i].x, tankList[i].y, tankList[i].ang);
          }

          window.requestAnimationFrame(gameLoop);
        }

        function Tank(x, y, topSpeed, topRotSpeed) {
          this.x = x;
          this.y = y;

          this.speed = 0;
          this.angle = 0;

          this.moveAngle = 0;
          this.topSpeed = topSpeed;
          this.topRotSpeed = topRotSpeed;

          this.update = function() {
            this.angle += this.moveAngle * Math.PI / 180;

            this.x += this.speed * Math.sin(this.angle);
            this.y -= this.speed * Math.cos(this.angle);

            if(this.x >= MAP_WIDTH) {
              this.x = MAP_WIDTH;
            }
            if(this.x <= 0) {
              this.x = 0;
            }
            if(this.y >= MAP_HEIGHT) {
              this.y = MAP_HEIGHT;
            }
            if(this.y <= 0) {
              this.y = 0;
            }
          }

          this.moveForward = function() {
            this.speed = this.topSpeed;
          }

          this.moveBackward = function() {
            this.speed = -this.topSpeed;
          }

          this.rotateLeft = function() {
            this.moveAngle = this.topRotSpeed;
          }

          this.rotateRight = function() {
            this.moveAngle = -this.topRotSpeed;
          }
        }

        function shot() {
          socket.send(JSON.stringify({
            pckid: 11,
            id: uuid
          }));
        }

        function drawBullet(x, y, ang) {
          var canvasX = (x / MAP_WIDTH) * canvas.width;
          var canvasY = (y / MAP_HEIGHT) * canvas.height;

          ctx.save();
          ctx.translate(canvasX, canvasY);
          ctx.rotate(ang * Math.PI / 180);
          ctx.fillStyle = "green";
          ctx.fillRect(5 / -2, 7 / -2, 5, 7);
          ctx.restore();
        }

        function drawTank(id, x, y, ang) {
          var canvasX = (x / MAP_WIDTH) * canvas.width;
          var canvasY = (y / MAP_HEIGHT) * canvas.height;

          ctx.save();

          ctx.translate(canvasX, canvasY);
          ctx.rotate(ang * Math.PI / 180);

          if (id == uuid) {
            ctx.fillStyle = "blue";
          } else {
            ctx.fillStyle = "red";
          }
          ctx.fillRect(-10, -12, 20, 24);

          ctx.restore();
        }

        function setText(message) {
          document.getElementById("info").innerHTML = message;
        }

        function resize() {
          console.log("resize");
          canvas.width = window.innerWidth - 2;
          canvas.height = window.innerWidth / 2;
        }

        window.addEventListener("resize", resize);
      });
    </script>
  </body>
</html>
